<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="img/favicon.png" sizes="any">
    <link rel="icon" href="img/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura tu tambor</title>
    <style>
        :root {
            --ui-background: #fff;
            --text-color: #000;
            --accent-color: #007bff;
            --border-color: #ddd; /* Lightened border color */
            --app-background: #fff; /* Lighter background */
            --container-background: #fff;
        }
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--app-background);
            color: var(--text-color);
        }
        #app-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        #main-container {
            display: flex;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            max-height: 800px;
            background-color: var(--container-background);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Softened shadow */
            overflow: hidden;
        }
        .ui-panel {
            flex: 0 0 300px;
            background-color: var(--ui-background);
            padding: 1.5rem;
            overflow-y: auto;
            box-sizing: border-box;
        }
        #canvas-container {
            flex: 1 1 auto;
            position: relative;
            min-width: 0;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .control-group {
            margin-bottom: 1.5rem;
        }
        .control-group:last-child {
            margin-bottom: 0;
        }
        label, .control-group h3 {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }
        .color-swatches {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem; /* Add space above swatches */
            flex-wrap: wrap;
        }
        .swatch {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: transform 0.2s;
        }
        .swatch:hover {
            transform: scale(1.1);
        }
        #error-message {
            color: #ff4d4d;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }
        .button, button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        .button:hover, button:hover {
            background-color: #0056b3;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            display: inline-block;
            cursor: pointer;
            padding: 0.75rem;
        }
        
        /* NEW: Center the color picker */
        #color-picker-container {
            margin: 0 auto;
        }

        @media (max-width: 768px) {
            #app-wrapper {
                padding: 1rem;
                height: auto;
                min-height: 100vh;
            }
            #main-container {
                flex-direction: column;
                height: 95vh;
            }
            .ui-panel {
                flex: 0 0 auto;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/controls/OrbitControls.js"
            }
        }
    </script>
</head>
<body>
    <div id="app-wrapper">
        <div id="main-container">
            <div class="ui-panel">
                <div class="control-group">
                    <h3>Configura tu Tambor</h3>
                    <div id="color-picker-container"></div>
                    <div class="color-swatches">
                        <div class="swatch" style="background-color: #ffffff;" data-color="#ffffff"></div>
                        <div class="swatch" style="background-color: #222222;" data-color="#222222"></div>
                        <div class="swatch" style="background-color: #201BD9;" data-color="#201BD9"></div>
                        <div class="swatch" style="background-color: #CA3838;" data-color="#CA3838"></div>
                        <div class="swatch" style="background-color: #FEB415;" data-color="#FEB415"></div>
                        <div class="swatch" style="background-color: #33AB57;" data-color="#33AB57"></div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>Sube tu logo</h3>
                    <label for="logo-upload" class="button file-label">Subir Imagen</label>
                    <input type="file" id="logo-upload" accept=".png, .jpg, .jpeg, .svg">
                    <div id="error-message"></div>
                </div>

                <div class="control-group">
                    <label for="scale-slider">Tama√±o del Logo</label>
                    <input type="range" id="scale-slider" min="0.1" max="1.5" step="0.05" value="0.5">
                </div>
                
                <div class="control-group">
                     <button id="download-btn">Descarga tu Captura</button>
                </div>
            </div>
            <div id="canvas-container"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        let scene, camera, renderer, controls, drumGroup, drumBody, logoMesh;
        
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        let isDraggingLogo = false;
        let isOrbiting = false; 

        const canvasWidth = 1250;
        const canvasHeight = 550;
        const offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = canvasWidth;
        offscreenCanvas.height = canvasHeight;
        const offscreenCtx = offscreenCanvas.getContext('2d');
        const logoTexture = new THREE.CanvasTexture(offscreenCanvas);

        let uploadedImage = null;
        const logoState = {
            x: 0, y: 0, width: 0, height: 0, scale: 0.5, dragStartX: 0, dragStartY: 0
        };

        const ui = {
            canvasContainer: document.getElementById('canvas-container'),
            swatches: document.querySelectorAll('.swatch'),
            logoUpload: document.getElementById('logo-upload'),
            scaleSlider: document.getElementById('scale-slider'),
            downloadBtn: document.getElementById('download-btn'),
            errorMessage: document.getElementById('error-message'),
        };

        // --- MODIFICATION: Initialize Iro.js Color Picker ---
        const colorPicker = new iro.ColorPicker('#color-picker-container', {
            width: 240,
            color: "#ffffff",
            borderWidth: 1,
            borderColor: "#ccc",
            layout: [
                { component: iro.ui.Box },
                { component: iro.ui.Slider, options: { sliderType: 'hue' } }
            ]
        });
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xefefef);

            const width = ui.canvasContainer.clientWidth;
            const height = ui.canvasContainer.clientHeight;
            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            camera.position.set(0, 7.5, 12); 
            camera.lookAt(0, 2.5, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            ui.canvasContainer.appendChild(renderer.domElement);

            addLights();
            createDrum();
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 2.5, 0);
            controls.enableDamping = true;
            controls.minDistance = 5;
            controls.maxDistance = 25;

            addEventListeners();
            animate();
        }

        function addLights() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 2.25);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 1024;
            directionalLight.shadow.mapSize.height = 1024;
            scene.add(directionalLight);
        }
        
        function createDrum() {
            drumGroup = new THREE.Group();
            const drumMaterial = new THREE.MeshStandardMaterial({
                color: 0xFFFFFF, metalness: 0.3, roughness: 0.4 
            });

            const drumHeight = 5.5;
            const drumRadius = 2;

            const bodyGeometry = new THREE.CylinderGeometry(drumRadius, drumRadius, drumHeight, 64);
            drumBody = new THREE.Mesh(bodyGeometry, drumMaterial.clone());
            drumBody.castShadow = true;
            drumBody.receiveShadow = true;
            drumGroup.add(drumBody);

            const logoGeometry = new THREE.CylinderGeometry(drumRadius + 0.01, drumRadius + 0.01, drumHeight, 64);
            
            const sideMaterial = new THREE.MeshStandardMaterial({
                color: 0xFFFFFF,
                map: logoTexture,
                transparent: true,
            });
            const capMaterial = new THREE.MeshStandardMaterial({ transparent: true, opacity: 0 });

            logoMesh = new THREE.Mesh(logoGeometry, [sideMaterial, capMaterial, capMaterial]);
            drumGroup.add(logoMesh);

            const lidGeometry = new THREE.CircleGeometry(drumRadius, 64);
            const topLid = new THREE.Mesh(lidGeometry, drumMaterial.clone());
            topLid.rotation.x = -Math.PI / 2;
            topLid.position.y = drumHeight / 2;
            drumGroup.add(topLid);

            const bottomLid = new THREE.Mesh(lidGeometry, drumMaterial.clone());
            bottomLid.rotation.x = Math.PI / 2;
            bottomLid.position.y = -drumHeight / 2;
            drumGroup.add(bottomLid);

            const rimGeometry = new THREE.TorusGeometry(drumRadius, 0.1, 16, 100);
            const topRim = new THREE.Mesh(rimGeometry, drumMaterial.clone());
            topRim.rotation.x = Math.PI / 2;
            topRim.position.y = drumHeight / 2;
            drumGroup.add(topRim);
            
            const bottomRim = new THREE.Mesh(rimGeometry, drumMaterial.clone());
            bottomRim.rotation.x = Math.PI / 2;
            bottomRim.position.y = -drumHeight / 2;
            drumGroup.add(bottomRim);

            const hoopGeometry = new THREE.TorusGeometry(drumRadius + 0.01, 0.05, 16, 100);
            [1.5, -1.5].forEach(y => {
                const hoop = new THREE.Mesh(hoopGeometry, drumMaterial.clone());
                hoop.rotation.x = Math.PI / 2;
                hoop.position.y = y;
                drumGroup.add(hoop);
            });
            
            const bungCapMaterial = new THREE.MeshStandardMaterial({
                color: 0x555555, metalness: 0.8, roughness: 0.3
            });
            const largeCapGeo = new THREE.CircleGeometry(0.2, 32);
            const smallCapGeo = new THREE.CircleGeometry(0.1, 32);
            
            const largeCap = new THREE.Mesh(largeCapGeo, bungCapMaterial);
            largeCap.rotation.x = -Math.PI / 2;
            largeCap.position.set(0, drumHeight / 2 + 0.01, 0.7);
            drumGroup.add(largeCap);
            
            const smallCap = new THREE.Mesh(smallCapGeo, bungCapMaterial);
            smallCap.rotation.x = -Math.PI / 2;
            smallCap.position.set(0, drumHeight / 2 + 0.01, -0.4);
            drumGroup.add(smallCap);

            drumGroup.position.y = drumHeight / 2 + 0.1;
            scene.add(drumGroup);
        }
        
        function redrawCanvas() {
            if (!offscreenCtx) return;
            offscreenCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            if (uploadedImage) {
                const aspectRatio = uploadedImage.naturalWidth / uploadedImage.naturalHeight;
                const baseHeight = canvasHeight * 0.5;
                const scaledHeight = baseHeight * logoState.scale;
                const scaledWidth = scaledHeight * aspectRatio;
                logoState.width = scaledWidth;
                logoState.height = scaledHeight;
                offscreenCtx.drawImage(uploadedImage, logoState.x, logoState.y, logoState.width, logoState.height);
            }
            logoTexture.needsUpdate = true;
        }

        function addEventListeners() {
            window.addEventListener('resize', onWindowResize);
            
            // --- MODIFICATION: Connect Iro.js to our update function ---
            colorPicker.on('color:change', function(color) {
                // color.hexString provides the color in #ffffff format
                updateDrumColor(color.hexString);
            });

            // --- MODIFICATION: Update swatches to control the new picker ---
            ui.swatches.forEach(swatch => {
                swatch.addEventListener('click', () => {
                    const color = swatch.dataset.color;
                    // Set the color on our new picker. This will also trigger the
                    // 'color:change' event, automatically updating the drum.
                    colorPicker.color.set(color);
                });
            });

            ui.logoUpload.addEventListener('change', handleFileUpload);
            ui.scaleSlider.addEventListener('input', (e) => {
                logoState.scale = parseFloat(e.target.value);
                redrawCanvas();
            });
            ui.downloadBtn.addEventListener('click', downloadSnapshot);
            controls.addEventListener('start', () => { isOrbiting = true; });
            controls.addEventListener('end', () => { isOrbiting = false; });
            renderer.domElement.addEventListener('pointerdown', onPointerDown);
            renderer.domElement.addEventListener('pointermove', onPointerMove);
            renderer.domElement.addEventListener('pointerup', onPointerUp);
            renderer.domElement.addEventListener('pointercancel', onPointerUp);
        }

        function updateDrumColor(hexColor) {
            const color = new THREE.Color(hexColor);
            drumGroup.children.forEach(child => {
                if (child.isMesh && child !== logoMesh) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(m => {
                            if (m.metalness < 0.5) m.color.set(color);
                        });
                    } else {
                        if (child.material.metalness < 0.5) {
                            child.material.color.set(color);
                        }
                    }
                }
            });
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            ui.errorMessage.textContent = '';
            if (!file) return;
            const allowedTypes = ['image/png', 'image/jpeg', 'image/svg+xml'];
            if (!allowedTypes.includes(file.type)) {
                ui.errorMessage.textContent = 'Invalid file type. Use PNG, JPG, or SVG.';
                return;
            }
            if (file.size > 5 * 1024 * 1024) { 
                ui.errorMessage.textContent = 'File is too large (max 5 MB).';
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    uploadedImage = img;
                    logoState.scale = parseFloat(ui.scaleSlider.value);
                    const aspectRatio = uploadedImage.naturalWidth / uploadedImage.naturalHeight;
                    const baseHeight = canvasHeight * 0.5;
                    const initialHeight = baseHeight * logoState.scale;
                    const initialWidth = initialHeight * aspectRatio;
                    logoState.x = (canvasWidth - initialWidth) / 2;
                    logoState.y = (canvasHeight - initialHeight) / 2;
                    redrawCanvas();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function onWindowResize() {
            const width = ui.canvasContainer.clientWidth;
            const height = ui.canvasContainer.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function onPointerDown(event) {
            updatePointer(event);
            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObject(drumBody);
            if (intersects.length > 0 && uploadedImage && Math.abs(intersects[0].face.normal.y) < 0.1) {
                const uv = intersects[0].uv;
                const canvasX = uv.x * canvasWidth;
                const canvasY = (1 - uv.y) * canvasHeight; 
                if (canvasX >= logoState.x && canvasX <= logoState.x + logoState.width &&
                    canvasY >= logoState.y && canvasY <= logoState.y + logoState.height) {
                    isDraggingLogo = true;
                    controls.enabled = false;
                    logoState.dragStartX = canvasX - logoState.x;
                    logoState.dragStartY = canvasY - logoState.y;
                }
            }
        }
        
        function onPointerMove(event) {
            if (isDraggingLogo) {
                updatePointer(event);
                raycaster.setFromCamera(pointer, camera);
                const intersects = raycaster.intersectObject(drumBody);
                if (intersects.length > 0) {
                    const uv = intersects[0].uv;
                    const canvasX = uv.x * canvasWidth;
                    const canvasY = (1 - uv.y) * canvasHeight;
                    logoState.x = canvasX - logoState.dragStartX;
                    logoState.y = canvasY - logoState.dragStartY;
                    redrawCanvas();
                }
            }
        }
        
        function onPointerUp() {
            isDraggingLogo = false;
            controls.enabled = true;
        }
        
        function updatePointer(event){
            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }
        
        function downloadSnapshot() {
            const dataURL = renderer.domElement.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = 'drum-snapshot.png';
            link.click();
        }
        
        function animate() {
            requestAnimationFrame(animate);
            if (!isOrbiting && !isDraggingLogo) {
                drumGroup.rotation.y += 0.004;
            }
            controls.update();
            renderer.render(scene, camera);
        }

        init();
        // Set the initial drum color from the picker's default value
        updateDrumColor(colorPicker.color.hexString);
    </script>
</body>
</html>